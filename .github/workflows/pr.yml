name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

env:
  BUN_VERSION: '1.2.19'

# Cancel previous runs for the same PR
concurrency:
  group: pr-${{ github.event.number }}
  cancel-in-progress: true

jobs:
  # Quick validation checks
  validate:
    name: ðŸ” Quick Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    outputs:
      has-changes: ${{ steps.changes.outputs.has-changes }}
      affected-packages: ${{ steps.changes.outputs.packages }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect changes
        id: changes
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "Changed files: $CHANGED_FILES"
          
          # Check if any source files changed
          if echo "$CHANGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json)$'; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
            
            # Detect affected packages
            PACKAGES=$(echo "$CHANGED_FILES" | grep -E '^packages/' | cut -d'/' -f2 | sort | uniq | tr '\n' ',' | sed 's/,$//')
            echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
            echo "Affected packages: $PACKAGES"
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: PR Info
        run: |
          echo "## PR Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Base**: ${{ github.event.pull_request.base.ref }}" >> $GITHUB_STEP_SUMMARY  
          echo "- **Head**: ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Changed**: $(echo '${{ steps.changes.outputs.has-changes }}' | tr ',' '\n' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Affected Packages**: ${{ steps.changes.outputs.packages }}" >> $GITHUB_STEP_SUMMARY

  # Fast code quality checks
  quick-checks:
    name: âš¡ Quick Checks
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.has-changes == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: TypeScript check
        run: bun run typecheck:all
      
      - name: Lint changed files
        run: |
          # Only lint changed files for faster feedback
          CHANGED_TS_FILES=$(git diff --name-only origin/main...HEAD | grep -E '\.(ts|tsx)$' || true)
          if [ -n "$CHANGED_TS_FILES" ]; then
            echo "Linting changed files: $CHANGED_TS_FILES"
            bun run lint:check
          else
            echo "No TypeScript files changed, skipping lint"
          fi
      
      - name: Format check
        run: bun run format:check

  # Run tests only for affected packages
  test-affected:
    name: ðŸ§ª Test Affected Packages
    runs-on: ubuntu-latest
    needs: [validate, quick-checks]
    if: needs.validate.outputs.has-changes == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(format('["{0}"]', needs.validate.outputs.affected-packages)) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Test package
        if: matrix.package != ''
        run: |
          if [ -d "packages/${{ matrix.package }}" ]; then
            cd packages/${{ matrix.package }}
            echo "Testing package: ${{ matrix.package }}"
            bun run test:unit
          else
            echo "Package ${{ matrix.package }} not found, skipping"
          fi
        env:
          TEST_TYPE: unit
          NODE_ENV: test

  # Build check
  build-check:
    name: ðŸ—ï¸ Build Check
    runs-on: ubuntu-latest
    needs: [validate, quick-checks]
    if: needs.validate.outputs.has-changes == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Build packages
        run: bun run build:all
      
      - name: Check build outputs
        run: |
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          for dir in packages/*/dist; do
            if [ -d "$dir" ]; then
              package_name=$(basename $(dirname $dir))
              file_count=$(find $dir -type f | wc -l)
              echo "- âœ… **$package_name**: $file_count files generated" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # Security scan
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.has-changes == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Security audit
        run: |
          bun audit --json > audit-results.json || true
          
          # Check for high/critical vulnerabilities
          HIGH_VULNS=$(cat audit-results.json | jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "high" or .value.severity == "critical") | .key' | wc -l)
          
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- **High/Critical vulnerabilities**: $HIGH_VULNS" >> $GITHUB_STEP_SUMMARY
          
          if [ "$HIGH_VULNS" -gt 0 ]; then
            echo "âš ï¸ High or critical vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… No high/critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

  # Integration tests for core interactions
  integration-test:
    name: ðŸ”§ Integration Test
    runs-on: ubuntu-latest
    needs: [validate, build-check]
    if: needs.validate.outputs.has-changes == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Build packages
        run: bun run build:all
      
      - name: Run integration tests
        run: bun run test:integration
        env:
          TEST_TYPE: integration
          NODE_ENV: test

  # Performance impact analysis
  performance-check:
    name: âš¡ Performance Impact
    runs-on: ubuntu-latest
    needs: [validate, build-check]
    if: needs.validate.outputs.has-changes == 'true' && contains(github.event.pull_request.labels.*.name, 'performance')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Build packages
        run: bun run build:all
      
      - name: Run performance tests
        run: |
          echo "Running performance analysis..."
          # Add performance testing logic
          echo "## Performance Impact" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle size changes: TBD" >> $GITHUB_STEP_SUMMARY
          echo "- Runtime performance: TBD" >> $GITHUB_STEP_SUMMARY

  # PR summary
  pr-summary:
    name: ðŸ“‹ PR Summary
    runs-on: ubuntu-latest
    needs: [validate, quick-checks, test-affected, build-check, security-scan, integration-test]
    if: always() && needs.validate.outputs.has-changes == 'true'
    
    steps:
      - name: Generate PR summary
        run: |
          echo "# ðŸŽ¯ PR Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status checks
          echo "## âœ… Status Checks" >> $GITHUB_STEP_SUMMARY
          echo "- **TypeScript**: ${{ needs.quick-checks.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ needs.test-affected.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ needs.build-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security**: ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration**: ${{ needs.integration-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Next steps
          echo "## ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.quick-checks.result }}" == "success" && "${{ needs.test-affected.result }}" == "success" && "${{ needs.build-check.result }}" == "success" ]]; then
            echo "âœ… **Ready for review!** All checks have passed." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Needs attention** - Some checks failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Changed Packages" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.validate.outputs.affected-packages }}" | tr ',' '\n' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

  # Auto-comment on PR
  comment-pr:
    name: ðŸ’¬ Comment on PR
    runs-on: ubuntu-latest
    needs: [pr-summary]
    if: always() && github.event_name == 'pull_request'
    
    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Check if we already commented
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ðŸ¤– Automated PR Check')
            );
            
            const commentBody = `## ðŸ¤– Automated PR Check Results
            